<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>직업 예측 AI</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --panel: rgba(255,255,255,0.05);
    --panel-border: rgba(255,255,255,0.12);
    --text:#e8eefc; --muted:#9fb0c9;
    --accent:#22d3ee; --accent2:#4ade80;
    --surface:#0b1220;

    --c1:#22d3ee; /* Top1 & 중앙 % */
    --c2:#4ade80; /* Top2 */
    --c3:#94a3b8; /* Top3 */
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:'Noto Sans KR',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:radial-gradient(1200px 600px at 20% 0%, #0f172a 0%, #0d1426 35%, #0a1224 60%, #0a1428 100%);
    color:var(--text);
  }
  .glass{
    background:var(--panel);
    border:1px solid var(--panel-border);
    backdrop-filter: blur(10px);
    box-shadow: 0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    border-radius:18px;
  }

  /* ===== 헤더 ===== */
  .heroTitle{
    font-size: 36px;
    line-height: 1.05;
    font-weight: 900;
    letter-spacing:.2px;
    text-align:right;
  }
  .heroSub{
    font-size:16px;
    color: var(--muted);
    font-weight: 600;
    text-align:right;
  }

  /* ===== 버튼 ===== */
  .btn{
    font-weight: 900;
    border:1px solid var(--panel-border);
    border-radius:14px;
    transition: transform .06s ease, filter .12s ease;
  }
  .btn:hover{ filter:brightness(1.06) }
  .btn:active{ transform:translateY(1px) }
  .btn[disabled]{ opacity:.6; cursor:not-allowed }
  .btn-lg{ padding:14px 22px; font-size:18px }
  .btn-xl{ padding:16px 26px; font-size:19px }
  .btn-primary{ background:linear-gradient(135deg,var(--accent) 0%,var(--accent2) 100%); color:#ffffff }
  .btn-secondary{ background:linear-gradient(135deg,#8b5cf6 0%,#06b6d4 100%) }

  /* ===== 카메라/세그 ===== */
  .mediaShell{position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--panel-border)}
  video,canvas,img{display:block;width:100%;height:auto}
  #overlay{position:absolute;left:0;top:0}
  .mediaShell video,.mediaShell canvas{transform:scaleX(-1);transform-origin:center}

  /* ===== 섹션 타이틀 ===== */
  .sectionTitle{
    color:#ffffff;
    font-size:24px;
    font-weight:900;
    letter-spacing:.2px;
  }

  /* ===== 내부 본문 20px ===== */
  .body20{ font-size:20px; line-height:1.6 }

  .top-list{display:grid;gap:12px}
  .top1{ font-size:22px; font-weight:900 }
  .top1 .pct{ font-weight:900; color:var(--c1) }
  .chip{
    display:inline-flex; gap:10px; align-items:center;
    padding:10px 14px; border:1px solid var(--panel-border);
    border-radius:999px; background:rgba(255,255,255,.06);
    font-weight:800; font-size:20px;
  }

  .donutWrap{display:grid;place-items:center}
  canvas#donut{width:min(340px, 70vw); height:auto; display:none}

  /* ===== 세그 이미지: contain + 중앙정렬 ===== */
  .segFrame{
    border:1px solid var(--panel-border);
    border-radius:16px; overflow:hidden;
    background:var(--surface);
    display:flex; align-items:center; justify-content:center;
    min-height: 280px;
  }
  .segImg{
    width:100%;
    height:100%;
    object-fit: contain;
    object-position: center;
    opacity:0; transition:opacity .18s ease;
    background:var(--surface);
  }

  .card-pad{ padding: 22px 24px }

  /* 스피너 */
  @keyframes rot { to { transform: rotate(360deg); } }
</style>
</head>
<body class="p-5 md:p-8">
  <div class="max-w-6xl mx-auto space-y-5">

    <!-- 헤더: 왼쪽 로고 / 오른쪽 제목·부제 -->
    <header class="glass card-pad">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="shrink-0">
          <img src="/assets/logo.png" alt="로고" style="height:48px;object-fit:contain" />
        </div>
        <div class="grow text-right">
          <h1 class="heroTitle">직업 예측 AI</h1>
          <p class="heroSub">울산세계미래산업박람회 | 2025.11.12-14</p>
        </div>
      </div>
    </header>

    <!-- 웹캠 -->
    <section class="glass card-pad space-y-5">
      <div class="mediaShell">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>
      <div class="flex flex-wrap gap-3 justify-between">
        <div class="flex gap-3">
          <button class="btn btn-secondary btn-lg" id="btnStart">웹캠 시작</button>
          <button class="btn btn-secondary btn-lg" id="btnStop">웹캠 중지</button>
        </div>
        <button class="btn btn-primary btn-xl" id="btnInfer">직업 유추하기</button>
      </div>
    </section>

    <!-- 예측 결과 -->
    <section class="glass card-pad space-y-4">
      <div class="flex items-center gap-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#ffffff" stroke-width="1.6"/><path d="M8 12h8M12 8v8" stroke="#ffffff" stroke-width="1.6"/></svg>
        <div class="sectionTitle">예측 결과</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
        <!-- 좌: Top-3 + 도넛 -->
        <div class="space-y-4 self-center">
          <div id="topList" class="top-list body20"></div>
          <div class="donutWrap">
            <canvas id="donut" width="340" height="340"></canvas>
          </div>
        </div>
        <!-- 우: Segmentation -->
        <div class="segFrame">
          <img id="segPreview" alt="세그 오버레이" class="segImg" style="display:block" />
        </div>
      </div>
    </section>

    <!-- 스타일 추천 -->
    <section class="glass card-pad space-y-3">
      <div class="flex items-center gap-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 7a5 5 0 0 1 10 0v1h1a3 3 0 0 1 3 3v7h-3v-6a2 2 0 0 0-2-2h-2" stroke="#ffffff" stroke-width="1.6"/><path d="M10 8H8a2 2 0 0 0-2 2v8H3v-7a3 3 0 0 1 3-3h1" stroke="#ffffff" stroke-width="1.6"/></svg>
        <div class="sectionTitle">스타일 추천</div>
      </div>
      <div id="stylistBox" class="body20" style="white-space:pre-line"></div>
    </section>

  </div>

  <!-- 로딩 오버레이 -->
  <div id="loaderOverlay" aria-hidden="true" style="display:none;position:fixed;inset:0;z-index:999999;align-items:center;justify-content:center;background:rgba(8,12,24,.6);backdrop-filter:blur(2px)">
    <div class="loaderBox" style="min-width:260px;padding:22px 24px;border-radius:16px;background:var(--panel);border:1px solid var(--panel-border);box-shadow:0 18px 80px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);text-align:center;color:#e8eefc">
      <div class="spinner" style="width:44px;height:44px;margin:0 auto 12px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:#4ade80;animation:rot .9s linear infinite"></div>
      <div class="loaderText" style="font-weight:900">분석 중…</div>
      <div class="loaderSub" style="margin-top:4px;font-size:12px;color:#9aa4b2">약 15초 정도 소요됩니다.</div>
    </div>
  </div>

<script>
  // ===== DOM =====
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnInfer = document.getElementById('btnInfer');

  const segPreview = document.getElementById('segPreview');
  const stylistBox = document.getElementById('stylistBox');

  const donutCanvas = document.getElementById('donut');
  const donutCtx = donutCanvas.getContext('2d');
  const topList = document.getElementById('topList');

  const loaderOverlay = document.getElementById('loaderOverlay');

  // ===== API =====
  const BASE = location.origin;
  const API_PRED_INLINE = BASE + "/api/v1/predict/inline";
  const API_SEG_JSON    = BASE + "/api/v1/segment/json";
  const API_VLM_JSON    = BASE + "/api/v1/vlm/json";
  const API_STYLIST     = BASE + "/api/v1/stylist/json";

  // ===== State/Palette =====
  let stream = null, running = false;
  let currentPalette = ['#22d3ee','#4ade80','#94a3b8'];
  const runState = { running: false, aborter: null };

  function applyPalette(colors){
    currentPalette = colors.slice(0,3);
    document.documentElement.style.setProperty('--c1', currentPalette[0]);
    document.documentElement.style.setProperty('--c2', currentPalette[1] || '#4ade80');
    document.documentElement.style.setProperty('--c3', currentPalette[2] || '#94a3b8');
  }

  // 현재 테마의 Top-1 색을 얻어 백엔드로 전달
  function getThemeC1(){
    const v = getComputedStyle(document.documentElement).getPropertyValue('--c1').trim();
    return v || '#22d3ee';
  }

  // ===== Helpers =====
  function syncOverlaySize(){ if(!video.videoWidth) return; overlay.width=video.videoWidth; overlay.height=video.videoHeight; }
  function showLoader(on){ loaderOverlay.style.display = on ? 'flex' : 'none'; loaderOverlay.setAttribute('aria-hidden', on ? 'false':'true'); }

  // ===== Webcam =====
  async function startCamera(){
    if(running) return;
    try{
      video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.muted = true;
      const constraints = { video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}}, audio:false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; await video.play();
      running = true; syncOverlaySize();
    }catch(e){
      console.error('카메라 실패:', e);
    }
  }
  function stopCamera(){
    running=false;
    try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); } }catch{}
    stream=null; try{ video.pause(); video.srcObject=null; }catch{}
    ctx.clearRect(0,0,overlay.width,overlay.height);
  }

  // ===== Stylist text =====
  function renderStylistText(raw){
    const safe = (raw || '').replace(/[\r\n]+/g, ' ').replace(/[“”"]/g, '');
    const escaped = safe.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const parts = escaped.split(/(?<=\.|!|\?)\s+/);
    const lines = parts.map(s => s.trim()).filter(Boolean);
    stylistBox.innerHTML = lines.join('<br>');
  }

  // ===== Donut =====
  function drawDonut(top3){
    const c = donutCanvas, g = donutCtx;
    g.clearRect(0,0,c.width,c.height);
    const cx=c.width/2, cy=c.height/2;
    const base = Math.min(c.width,c.height);
    const r = base * 0.35;
    const w = base * 0.09;
    const total = top3.reduce((a,b)=>a+b.prob,0) || 1;
    let ang = -Math.PI/2;

    top3.forEach((d,i)=>{
      const col = currentPalette[i % currentPalette.length];
      const a2 = ang + (d.prob/total)*Math.PI*2;
      g.beginPath(); g.arc(cx,cy,r,ang,a2);
      g.strokeStyle = col; g.lineWidth = w; g.lineCap='round'; g.stroke();
      ang=a2;
    });

    g.fillStyle = currentPalette[0];
    g.font = `900 ${Math.round(base*0.085)}px 'Noto Sans KR',sans-serif`;
    g.textAlign="center"; g.textBaseline="middle";
    g.fillText(`${Math.round((top3[0]?.prob||0)*100)}%`, cx, cy);

    c.style.display = 'block';
  }

  // ===== Top-3 Renderer =====
  function renderTop3(allSorted){
    const top3 = allSorted.slice(0,3);
    topList.innerHTML = '';
    if (!top3.length) return;

    applyPalette(['#22d3ee','#4ade80','#94a3b8']);

    const t1 = document.createElement('div');
    t1.className = 'top1';
    t1.innerHTML = `<span>${top3[0].label}</span> <span class="pct">${Math.round(top3[0].prob*100)}%</span>`;
    topList.appendChild(t1);

    const row = document.createElement('div');
    row.className = 'flex gap-2 flex-wrap';
    for (let i=1;i<3;i++){
      if(!top3[i]) continue;
      const chip = document.createElement('div');
      chip.className = 'chip';
      const colorVar = i===1 ? 'var(--c2)' : 'var(--c3)';
      chip.innerHTML = `<span>${top3[i].label}</span> <span style="color:${colorVar}">${Math.round(top3[i].prob*100)}%</span>`;
      row.appendChild(chip);
    }
    topList.appendChild(row);

    drawDonut(top3);
  }

  // ===== Segmentation 스왑 로더 =====
  function swapSegImage(url){
    if(!url){ segPreview.style.opacity = 0; return; }
    const cacheBusted = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
    const img = new Image();
    img.onload = () => { segPreview.src = cacheBusted; segPreview.style.opacity = 1; };
    img.onerror = () => { segPreview.style.opacity = 0; };
    img.src = cacheBusted;
  }

  // ===== Render (VLM+Seg) =====
  function parseProb(x){
    if (typeof x === 'string'){
      const s=x.trim(); if(s.endsWith('%')){ const v=parseFloat(s.slice(0,-1)); return Number.isFinite(v)?Math.max(0,Math.min(1,v/100)):0; }
      const v=parseFloat(s); if(!Number.isFinite(v)) return 0; return v>1&&v<=100? v/100 : Math.max(0,Math.min(1,v));
    }
    const n=Number(x); if(!Number.isFinite(n)) return 0; return n>1&&n<=100? n/100 : Math.max(0,Math.min(1,n));
  }

  async function renderVLM(v){
    const r = (v?.vlm?.result) ? v.vlm.result : (v?.result || {});
    const rawCand = Array.isArray(r.candidates) ? r.candidates : [];
    const candOnly = rawCand.map(d=>({label:d.job||'기타', prob:parseProb(d.prob)})).sort((a,b)=>b.prob-a.prob);

    const topLabelFromTop = r.top_prediction?.job;
    const topProbFromTop  = parseProb(r.top_prediction?.confidence);

    let all = [];
    const norm = s => (s||'').toString().toLowerCase().replace(/\s+/g,'').replaceAll('/','');
    if (topLabelFromTop && Number.isFinite(topProbFromTop)){
      all.push({label:topLabelFromTop, prob:topProbFromTop});
      const key = norm(topLabelFromTop);
      candOnly.forEach(c=>{ if(norm(c.label)!==key) all.push(c); });
    }else{
      all = candOnly.slice();
    }

    renderTop3(all);

    const overlayUrl = v.overlay_url || v?._seg?.overlay_url || '';
    swapSegImage(overlayUrl);

    const top3 = all.slice(0,3).map(d=>d.label);
    const evidence = Array.isArray(r.evidence) ? r.evidence : [];
    try{
      const res = await fetch(API_STYLIST, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ job: top3[0]||'', top3, evidence })
      });
      if(res.ok){
        const sj = await res.json();
        renderStylistText((sj?.text || '').trim());
      }else{
        stylistBox.textContent = '스타일 추천 생성 실패';
      }
    }catch(e){
      console.error(e);
      stylistBox.textContent = '스타일 추천 호출 오류';
    }
  }

  // ===== Backend Calls (★ meta.c1 포함) =====
  async function callPredictInline(dataURL, signal){
    const res = await fetch(API_PRED_INLINE, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ image:dataURL, meta:{ c1: getThemeC1() } }),
      signal
    });
    if (res.status === 404) throw new Error("INLINE_404");
    if (!res.ok) throw new Error(`INLINE ${res.status}`);
    return res.json();
  }
  async function callLegacyTwoStep(dataURL, signal){
    const segRes=await fetch(API_SEG_JSON,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ image:dataURL, meta:{ c1: getThemeC1() } }), signal
    });
    if(!segRes.ok) throw new Error(`SEG ${segRes.status}`);
    const seg=await segRes.json();
    const vlmRes=await fetch(API_VLM_JSON,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ cutout_url:seg.url }), signal
    });
    if(!vlmRes.ok) throw new Error(`VLM ${vlmRes.status}`);
    const j=await vlmRes.json();
    return { overlay_url: seg.overlay_url, cutout_url: seg.url, vlm: j, _seg: seg };
  }

  function nextPaint(){ return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r))); }
  function blobToDataURL(blob){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(blob);
    });
  }

  // ===== Pipeline =====
  async function sendFrameJSON(){
    if (runState.running && runState.aborter) { try{ runState.aborter.abort(); }catch(e){} }
    topList.innerHTML = '';
    donutCtx.clearRect(0,0,donutCanvas.width,donutCanvas.height);
    donutCanvas.style.display = 'none';
    stylistBox.textContent = '';
    segPreview.style.opacity = 0;
    ctx.clearRect(0,0,overlay.width,overlay.height);

    btnInfer.disabled = true; btnInfer.textContent = '분석 중…'; showLoader(true);
    await nextPaint();

    runState.aborter = new AbortController(); runState.running = true;

    try{
      if(!video.videoWidth) throw new Error("no_frame");
      const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
      const cctx=c.getContext('2d'); cctx.translate(c.width,0); cctx.scale(-1,1); cctx.drawImage(video,0,0,c.width,c.height);

      const blob = await new Promise(res => c.toBlob(res, 'image/png', 0.92));
      if(!blob) throw new Error("capture_failed");
      const dataURL = await blobToDataURL(blob);

      let resp;
      try{
        resp = await callPredictInline(dataURL, runState.aborter.signal);
      }catch(err){
        if(err?.message==="INLINE_404"){ resp = await callLegacyTwoStep(dataURL, runState.aborter.signal); }
        else{ throw err; }
      }
      await renderVLM(resp);

    }catch(err){
      if (err?.name !== 'AbortError') { console.error(err); }
    }finally{
      runState.running = false; btnInfer.disabled=false; btnInfer.textContent='직업 유추하기'; showLoader(false);
    }
  }

  // ===== Events/Init =====
  btnStart.addEventListener('click', startCamera);
  btnStop .addEventListener('click', stopCamera);
  btnInfer.addEventListener('click', sendFrameJSON);
  video.addEventListener('loadedmetadata', syncOverlaySize);
  window.addEventListener('resize', syncOverlaySize);
  (async()=>{ try{ const dev=await navigator.mediaDevices.enumerateDevices(); if(dev.some(d=>d.kind==='videoinput')) startCamera(); }catch(e){} })();
</script>
</body>
</html>
