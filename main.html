<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outfit → Segmentation → VLM 직업 예측 (MVP)</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #11172b;
      --muted: #9aa4b2;
      --text: #e8eefc;
      --accent: #4ade80;
      --accent2: #22d3ee;
      --border: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: radial-gradient(1200px 800px at 10% 0%, #0d1732 0, #0b1120 35%, #0b1020 100%);
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .muted { color: var(--muted); font-size: 13px; }

    .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 16px; align-items: start; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: 14px; padding: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { margin: 6px 0; }
    .btn {
      background: linear-gradient(180deg, #17213f, #121a33);
      border: 1px solid var(--border); color: #eaf2ff;
      padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .okdot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; margin-right: 6px; background: #ef4444; box-shadow: 0 0 10px #ef4444aa; }
    #camStatus { font-size: 13px; color: var(--muted); }

    .mediaShell { position: relative; border-radius: 12px; overflow: hidden; background: #0b142a; border: 1px solid var(--border); }
    video, canvas { display: block; width: 100%; height: auto; }
    #overlay { position: absolute; left: 0; top: 0; }

    .kbd { background: #0d1530; border: 1px solid var(--border); padding: 4px 8px; border-radius: 6px; font-size: 12px; color: var(--muted); }

    .progress { width: 100%; height: 8px; border-radius: 999px; background: rgba(255,255,255,0.08); overflow: hidden; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); transition: width .25s ease; }

    .chip { background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: #dbe7ff; padding: 6px 10px; border-radius: 999px; }
    .stack { display: grid; gap: 10px; }

    .checker {
      background:
      linear-gradient(45deg, #0000 46%, #ffffff14 47% 53%, #0000 54%),
      linear-gradient(-45deg, #0000 46%, #ffffff14 47% 53%, #0000 54%);
      background-size: 18px 18px;
    }
    img.result {
      width: 100%; border-radius: 10px; border: 1px solid var(--border); background: #0b142a; display: block;
      object-fit: contain;
    }
    a { color: #a3d4ff; text-decoration: underline; }
    .probRow { width: 100%; }
    .probRail { height: 8px; width: 100%; border-radius: 999px; background: rgba(255,255,255,0.10); overflow: hidden; }
    .probFill { height: 100%; background: rgba(255,255,255,0.38); }
    .probFill.top { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
    .meta { font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Outfit → Segmentation → VLM 직업 예측</h1>
    <div class="muted">웹캠 또는 파일 업로드로 의상을 분리(누끼)하고, VLM(Qwen2-VL)로 직업군을 자동 추정합니다.</div>

    <div class="grid" style="margin-top:16px">
      <!-- 좌: 입력/웹캠 -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="okdot" id="okDot"></span>
            <span id="camStatus">카메라 대기</span>
          </div>
          <div class="meta"><span id="liveFPS">—</span></div>
        </div>

        <div class="mediaShell" style="margin-top:8px">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="overlay"></canvas>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnStart">웹캠 시작</button>
          <button class="btn" id="btnStop">웹캠 중지</button>
          <button class="btn" id="btnSnap">현재 프레임 → 세그+VLM</button>
          <span class="kbd">또는 이미지 업로드 →</span>
          <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" />
        </div>
      </div>

      <!-- 우: 결과 -->
      <div class="card stack">
        <div>
          <div class="row" style="justify-content:space-between; align-items: end;">
            <div>
              <div class="meta">예측 직업</div>
              <div id="predJob" style="font-weight:800;font-size:20px;line-height:1.2">—</div>
            </div>
            <div style="min-width:180px">
              <div class="meta" style="margin-bottom:6px" id="confText">신뢰도 —</div>
              <div class="progress"><div class="bar" id="confBar"></div></div>
            </div>
          </div>
          <div class="meta" id="predReason" style="margin-top:6px">—</div>
        </div>

        <div>
          <div class="meta" style="margin-bottom:6px">VLM 근거</div>
          <div id="evidenceChips" class="row"></div>
        </div>

        <div>
          <div class="meta" style="margin-bottom:6px">직업 확률</div>
          <div id="probsList" class="stack"></div>
        </div>

        <div>
          <div class="meta" style="margin-bottom:6px">세그 결과 (배경 투명)</div>
          <div class="checker" style="border-radius:12px; padding:8px; border:1px solid var(--border);">
            <img id="cutoutImg" class="result" alt="cutout result"/>
          </div>
          <div id="cutoutLink" class="meta" style="margin-top:6px"></div>
          <div id="detectInfo" class="meta" style="margin-top:2px"></div>
        </div>

        <div>
          <div class="meta" style="margin-bottom:6px">검출 오버레이</div>
          <img id="overlayImg" class="result" alt="overlay" />
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== DOM ======
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const btnStart = document.getElementById('btnStart');
    const btnStop  = document.getElementById('btnStop');
    const btnSnap  = document.getElementById('btnSnap');
    const fileInput = document.getElementById('fileInput');
    const camStatus = document.getElementById('camStatus');
    const okDot = document.getElementById('okDot');
    const liveFPS = document.getElementById('liveFPS');
    const predJob = document.getElementById('predJob');
    const predReason = document.getElementById('predReason');
    const confBar = document.getElementById('confBar');
    const confText = document.getElementById('confText');
    const evidenceChips = document.getElementById('evidenceChips');
    const probsList = document.getElementById('probsList');
    const cutoutImg = document.getElementById('cutoutImg');
    const cutoutLink = document.getElementById('cutoutLink');
    const detectInfo = document.getElementById('detectInfo');
    const overlayImg = document.getElementById('overlayImg');

    // ====== API BASE ======
    const BASE = location.origin;
    const API_SEG_FILE = BASE + "/api/v1/segment/file";
    const API_SEG_JSON = BASE + "/api/v1/segment/json";
    const API_VLM_JSON = BASE + "/api/v1/vlm/json";

    // ====== State ======
    let stream = null, running = false;
    let lastTS = performance.now(), frames = 0;

    // ====== Helpers ======
    function setStatus(text, ok=true) {
      camStatus.textContent = text;
      okDot.style.background = ok ? '#10b981' : '#ef4444';
      okDot.style.boxShadow  = ok ? '0 0 12px #10b981aa' : '0 0 12px #ef4444aa';
    }
    function chip(text) {
      const s = document.createElement('span');
      s.className = 'chip';
      s.textContent = text;
      return s;
    }
    function percent(x) { return Math.max(0, Math.min(100, Math.round(x*100))); }
    function syncOverlaySize() {
      if (!video.videoWidth) return;
      overlay.width  = video.videoWidth;
      overlay.height = video.videoHeight;
    }
    function updateFPS() {
      frames++;
      const now = performance.now();
      if (now - lastTS >= 1000) { liveFPS.textContent = `${frames} FPS`; frames = 0; lastTS = now; }
    }
    function renderProbabilities(distArr) {
      probsList.innerHTML = '';
      const maxProb = Math.max(...distArr.map(d => d.prob));
      distArr.forEach(({label, prob}) => {
        const pct = percent(prob);
        const row = document.createElement('div');
        row.className = 'probRow';
        row.innerHTML = `
          <div class="row" style="justify-content:space-between; font-size:12px; color:#cdd7ee; margin-bottom:4px">
            <span>${label}</span><span>${pct}%</span>
          </div>
          <div class="probRail"><div class="probFill ${prob===maxProb ? 'top' : ''}" style="width:${pct}%"></div></div>
        `;
        probsList.appendChild(row);
      });
    }

    // ====== Camera ======
    async function startCamera() {
      if (running) return;
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720} }, audio:false
        });
        video.srcObject = stream;
        await video.play();
        running = true;
        syncOverlaySize();
        setStatus('카메라 실행중');
      } catch (e) {
        setStatus('카메라 접근 거부/오류', false);
        console.error(e);
      }
    }
    function stopCamera() {
      running = false;
      if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
      ctx.clearRect(0,0,overlay.width, overlay.height);
      setStatus('카메라 중지됨', false);
    }

    // ====== Segment + VLM pipeline ======
    async function callVLM(cutoutUrl) {
      try {
        predJob.textContent = "직업 분석중…";
        confBar.style.width = "0%";
        confText.textContent = "신뢰도 —";
        evidenceChips.innerHTML = "";

        const res = await fetch(API_VLM_JSON, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cutout_url: cutoutUrl })
        });
        if (!res.ok) throw new Error(`VLM ${res.status}`);
        const v = await res.json();
        const r = (v && v.result) ? v.result : {};
        const top = r.top_prediction || {};
        const dist = Array.isArray(r.candidates) ? r.candidates : [];

        const job = top.job || "분류 실패";
        const conf = Math.max(0, Math.min(1, Number(top.confidence || 0)));
        predJob.textContent = job;
        confBar.style.width = `${Math.round(conf * 100)}%`;
        confText.textContent = `신뢰도 ${Math.round(conf * 100)}%`;

        const ev = Array.isArray(r.evidence) ? r.evidence : [];
        evidenceChips.innerHTML = "";
        if (ev.length === 0) evidenceChips.appendChild(chip("단서 없음"));
        else ev.slice(0,8).forEach(s => evidenceChips.appendChild(chip(String(s))));
        predReason.textContent = ev.length ? `주요 단서: ${ev.slice(0,3).join(" · ")}` : "명확한 단서가 부족합니다.";

        const distNormalized = dist.map(d => ({
          label: d.job || "기타",
          prob: Math.max(0, Math.min(1, Number(d.prob || 0)))
        }));
        if (distNormalized.length) renderProbabilities(distNormalized);
      } catch (e) {
        console.error(e);
        predJob.textContent = "VLM 호출 실패";
        predReason.textContent = "서버 로그 확인 필요";
      }
    }

    function showSegmentResult(seg) {
      const fullCut = seg.url.startsWith('http') ? seg.url : (BASE + seg.url);
      cutoutImg.src = fullCut;
      cutoutLink.innerHTML = `<a href="${fullCut}" target="_blank">다운로드: ${seg.filename || fullCut}</a>`;
      detectInfo.textContent = `detections: ${seg.detections}`;
      if (seg.overlay_url) {
        const fullOv = seg.overlay_url.startsWith('http') ? seg.overlay_url : (BASE + seg.overlay_url);
        overlayImg.src = fullOv;
      }
      // 자동 VLM
      callVLM(seg.url);
    }

    async function sendFile(file) {
      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch(API_SEG_FILE, { method: "POST", body: fd });
      if (!res.ok) throw new Error(`SEG ${res.status}`);
      const j = await res.json();
      showSegmentResult(j);
    }

    async function sendFrameJSON() {
      if (!video.videoWidth) return;
      // 현재 프레임을 캡처 → dataURL
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      const cctx = c.getContext('2d');
      // 전면 카메라 미러링 고려 (이미지를 그대로 쓰고 싶으면 아래 두 줄 주석)
      cctx.translate(c.width, 0); cctx.scale(-1, 1);
      cctx.drawImage(video, 0, 0, c.width, c.height);
      const dataURL = c.toDataURL('image/png', 0.92);

      const res = await fetch(API_SEG_JSON, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: dataURL })
      });
      if (!res.ok) throw new Error(`SEG ${res.status}`);
      const j = await res.json();
      showSegmentResult(j);
    }

    // ====== Events ======
    btnStart.addEventListener('click', startCamera);
    btnStop.addEventListener('click', stopCamera);
    btnSnap.addEventListener('click', sendFrameJSON);
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) sendFile(f).catch(console.error);
      fileInput.value = "";
    });
    video.addEventListener('loadedmetadata', syncOverlaySize);
    window.addEventListener('resize', syncOverlaySize);

    // ====== Auto-init if camera available ======
    (async () => {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        if (devices.some(d => d.kind === 'videoinput')) startCamera();
      } catch(e) {}
    })();

    // ====== Simple overlay loop (FPS only) ======
    (function rafLoop(){
      if (running) updateFPS();
      requestAnimationFrame(rafLoop);
    })();
  </script>
</body>
</html>
