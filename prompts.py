# prompts.py
from __future__ import annotations
import json
from typing import List, Optional, Dict

# === 카테고리 정의(21개 고정) ===
CATEGORIES: List[str] = [
    "의료직","요식/조리","건설/현장","물류/배송","제조/공장","과학/실험","공공안전/치안",
    "군/경비","교육/보육","사무/기업","리테일/판매","미용/뷰티","스포츠/피트니스",
    "관광/항공/호텔","예술/공연/미디어","기술/IT/크리에이터","건물관리/청소",
    "농림어업/야외","학생/교복","종교/성직","운수/대중교통"
]

# 힌트북(있다면 채워넣기; 비워도 동작)
CATEGORY_HINTS: Dict[str, List[str]] = {}
HINTS_JSON = json.dumps(CATEGORY_HINTS, ensure_ascii=False, indent=2)

# === LLM 출력 스키마(Top-3 전용) ===
# candidates에는 반드시 상위 3개만 포함되며, prob 합=1.0
SCHEMA = r"""
{
  "top_prediction": {"job": "직업명", "confidence": 0.83},
  "candidates": [
    {"job": "사무/기업", "prob": 0.60},
    {"job": "기술/IT/크리에이터", "prob": 0.25},
    {"job": "리테일/판매", "prob": 0.15}
  ],
  "evidence": ["셔츠","재킷","백팩"]
}
""".strip()

# === 생성 규칙(Top-3 강제) ===
PROMPT_RULES = """
규칙:
1) 아래 21개 카테고리만 사용하고, 철자/띄어쓰기를 정확히 맞추세요. 새 라벨을 만들지 마세요.
2) candidates 배열에는 '딱 3개'만 포함합니다. 세 후보의 prob 합은 정확히 1.0이 되도록 하세요.
3) 각 prob는 0.05 이상 0.90 이하의 '유효한 JSON 숫자'여야 합니다(문자열/퍼센트 금지).
4) top_prediction.job 은 candidates 중 최댓값의 job, confidence 는 그 prob 값과 정확히 동일해야 합니다.
5) evidence 는 이미지에서 감지된 의복/장비 단서를 1~6개 한국어 명사로 작성합니다(예: '랩코트','보안경','청바지','백팩').
6) 출력은 반드시 '순수 JSON'만. 주석/설명/마크다운/코드블록 모두 금지.
""".strip()

EXAMPLE = r"""
예시(JSON):
{
  "top_prediction": {"job": "과학/실험", "confidence": 0.62},
  "candidates": [
    {"job":"과학/실험","prob":0.62},
    {"job":"사무/기업","prob":0.23},
    {"job":"기술/IT/크리에이터","prob":0.15}
  ],
  "evidence":["랩코트","보안경","니트ril 장갑"]
}
""".strip()

# === 분류 프롬프트(Top-3 전용) ===
def get_vlm_prompt(lang: str = "ko") -> str:
    return (
        "아래 이미지는 배경이 제거된 사람입니다.\n"
        "의상 스타일(의상 색과 소재, 종류 등)과 소지품 단서를 바탕으로 예상 직업을 추정해 주세요.\n"
        "반드시 'Top-3'만 포함하는 JSON으로 응답하세요.\n\n"
        + "CATEGORIES:\n" + json.dumps(CATEGORIES, ensure_ascii=False) + "\n\n"
        + "CUE_BOOK:\n" + HINTS_JSON + "\n\n"
        + "SCHEMA:\n" + SCHEMA + "\n\n"
        + PROMPT_RULES + "\n\n"
        + EXAMPLE
    )

def get_categories(lang: str = "ko") -> List[str]:
    return CATEGORIES

# === 시스템 프롬프트(분류) ===
def get_system_prompt(lang: str = "ko") -> str:
    return (
        "당신은 한국어만 사용하는 도우미입니다. "
        "반드시 한국어 JSON만 출력하십시오. "
        "키 이름과 직업 카테고리 명칭도 전부 한국어를 사용하십시오. "
        "설명 문장이나 주석 없이 JSON만 출력하십시오."
    )

# ======================================================================
# ======================= 스타일 제안 파트(문장형) =======================
# ======================================================================

# 템플릿 복제를 유발하던 고정 예시어(증거에 없으면 사용 금지)
FORBIDDEN_DEFAULTS = ["흰색 셔츠", "검정 슬랙스", "네이비 재킷", "논슬립"]

# 21개 카테고리 전부에 대한 스타일 힌트
STYLE_BOOK: Dict[str, List[str]] = {
    "의료직": [
        "화이트/민트 스크럽 상의와 네이비 스크럽 팬츠, 경량 클로그",
        "라이트그레이 스크럽과 버튼형 카디건, 워셔블 논슬립 의료화",
        "티얼 그린 스크럽 셋업과 컴프레션 삭스, 방수 손목시계"
    ],
    "요식/조리": [
        "차콜 밴드칼라 셔츠와 블랙 스트레치 팬츠, 논슬립 클로그",
        "그레이/브라운 투톤 에이프런과 딥네이비 팬츠, 쿠셔닝 워크슈즈",
        "딥그린 셰프자켓과 카본 팬츠, 방오 코팅 논슬립"
    ],
    "건설/현장": [
        "하이비즈 상의와 올리브 카고 팬츠, 토캡 안전화",
        "샌드 컬러 셔츠 재킷과 다크그레이 워크팬츠, 미끄럼 방지 부츠",
        "차콜 플리스 미드레이어와 네이비 카고, 리플렉티브 캡"
    ],
    "물류/배송": [
        "네이비 폴로와 스트레치 치노, 쿠셔닝 트레일 스니커즈",
        "라이트그레이 기능 티와 블랙 조거, 발목 지지형 워크화",
        "올리브 셔츠 재킷과 카본 팬츠, 펙스용 장갑"
    ],
    "제조/공장": [
        "차콜 점프수트와 경량 안전화, 절연 장갑",
        "네이비 워크셔츠와 스틸 그레이 팬츠, 방진 마스크",
        "라이트그레이 코튼 재킷과 블랙 카고, 귀마개/아이프로텍터"
    ],
    "과학/실험": [
        "라이트그레이 랩코트와 네이비 팬츠, 니트릴 장갑",
        "스톤 컬러 랩가운과 차콜 치노, 클린룸용 슈커버",
        "화이트 랩코트와 카본 슬랙스, 보안경"
    ],
    "공공안전/치안": [
        "네이비 셔츠형 재킷과 카고 팬츠, 듀러블 워크화",
        "다크네이비 셋업과 멀티포켓 벨트, 경량 장갑",
        "하이비즈 조끼와 차콜 팬츠, 미끄럼 방지 부츠"
    ],
    "군/경비": [
        "올리브 드랍 셔츠와 립스탑 팬츠, 하이그립 부츠",
        "코요테 브라운 셔츠 재킷과 카키 카고, 기능 벨트",
        "차콜 컴뱃 셔츠와 샌드 팬츠, 전술 글러브"
    ],
    "교육/보육": [
        "라이트블루 옥스퍼드와 크림 치노, 소프트 로퍼",
        "페일 핑크 니트와 그레이 슬랙스, 로우 힐",
        "스트라이프 셔츠와 네이비 스커트/팬츠, 미니멀 플랫"
    ],
    "사무/기업": [
        "라이트블루 셔츠와 차콜 그레이 팬츠, 브라운 로퍼",
        "크림 니트 폴로와 스틸 그레이 치노, 블랙 더비",
        "연베이지 셋업과 더스트핑크 셔츠, 다크브라운 벨트"
    ],
    "리테일/판매": [
        "버건디 폴로와 네이비 치노, 쿠셔닝 스니커즈",
        "스트라이프 셔츠와 크림 팬츠, 라이트그레이 카디건",
        "라이트데님 셔츠와 블랙 슬림 팬츠, 컴포트 로퍼"
    ],
    "미용/뷰티": [
        "블랙 튜닉과 슬림 팬츠, 워셔블 플랫",
        "샌드 컬러 셔츠 원피스와 미들 힐, 미니멀 에이프런",
        "스톤 그레이 셋업과 누드 톤 슈즈, 가벼운 액세서리"
    ],
    "스포츠/피트니스": [
        "모노톤 트레이닝 셋업과 경량 러닝화",
        "드라이 티와 압박 레깅스/조거, 쿠셔닝 트레이너",
        "지퍼 후디와 메시 쇼츠, 멀티코트 스니커즈"
    ],
    "관광/항공/호텔": [
        "네이비 베스트와 스카프, 차콜 스커트/팬츠, 로우 힐",
        "스카이블루 셔츠와 다크네이비 팬츠, 미끄럼 방지 플랫",
        "크림 블라우스와 스톤 슬랙스, 미니멀 펌프스"
    ],
    "예술/공연/미디어": [
        "블랙 셔츠와 와이드 슬랙스, 체시 스니커즈",
        "차콜 카디건과 인디고 진, 미니멀 부츠",
        "다크 그린 셔츠 재킷과 블랙 데님, 캔버스화"
    ],
    "기술/IT/크리에이터": [
        "차콜 후디와 슬림 조거, 경량 스니커즈",
        "블랙 티와 그레이 슬랙스, 니트 집업",
        "스톤 컬러 셔츠와 인디고 진, 미니멀 스니커즈"
    ],
    "건물관리/청소": [
        "라이트그레이 유니폼 상·하의, 워셔블 논슬립",
        "네이비 작업 셔츠와 카본 팬츠, 고무장갑",
        "민트 폴로와 다크그레이 팬츠, 쿠셔닝 워크화"
    ],
    "농림어업/야외": [
        "올리브 방수 재킷과 립스탑 팬츠, 러깅 부츠",
        "샌드 브림 햇과 카키 셔츠, 방충 메쉬 베스트",
        "차콜 플리스와 올리브 카고, 미끄럼 방지 장화"
    ],
    "학생/교복": [
        "네이비 가디건과 화이트 셔츠, 체크 스커트/슬랙스",
        "차콜 블레이저와 라이트그레이 팬츠, 로퍼",
        "브이넥 니트와 네이비 하의, 심플 스니커즈"
    ],
    "종교/성직": [
        "다크톤 로브와 미니멀 플랫/로퍼",
        "차콜 셔츠와 블랙 팬츠, 절제된 액세서리",
        "네이비 톤 셋업과 소프트 솔 슈즈"
    ],
    "운수/대중교통": [
        "네이비 셔츠형 유니폼과 차콜 팬츠, 논슬립 워크화",
        "라이트블루 셔츠와 다크네이비 하의, 편평 솔 슈즈",
        "차콜 조끼와 네이비 팬츠, 쿠셔닝 로퍼"
    ],
}

def _contains_any_token(text: str, tokens: List[str]) -> bool:
    t = text.replace(" ", "")
    return any(tok.replace(" ", "") in t for tok in tokens)

# === 시스템 프롬프트(스타일리스트; 문장형) ===
def get_system_prompt_stylist(lang: str = "ko") -> str:
    return (
        "당신은 한국어만 사용하는 스타일 컨설턴트입니다. "
        "반드시 한국어 '문장'만 출력하고, 불릿/코드블록/목록/JSON은 사용하지 마십시오. "
        "각 문장을 마침표로 끝내고, 문장마다 줄바꿈을 하십시오(한 줄에 한 문장). "
        "예시 문구를 답변에 재사용하지 마십시오. "
        "총 3~5문장으로 간결하고 공손하게 작성하십시오."
    )

# === 스타일 제안 프롬프트(문장형 결과) ===
def get_stylist_prompt(
    job_ko: str,
    evidence: Optional[List[str]] = None,
    two_alternatives: bool = False,   # True면 1안/2안으로 서로 다른 조합 요구
) -> str:
    """
    스타일 제안 프롬프트(문장형).
    - 고정 예시어(FORBIDDEN_DEFAULTS)를 증거 기반으로 금지.
    - 카테고리별 STYLE_BOOK 힌트로 색/아이템 다양성 유도.
    - two_alternatives=True 시 1안/2안 두 가지 대안을 요구.
    - 문장별 줄바꿈 강제.
    """
    ev_list = evidence or []
    ev_text = ", ".join(ev_list) if ev_list else "감지된 의복/장비 단서 없음"

    # evidence에 포함되지 않은 금지어 생성
    forbidden_terms = [
        w for w in FORBIDDEN_DEFAULTS
        if not any(_contains_any_token(e, [w]) for e in ev_list)
    ]
    forbid_clause = ""
    if forbidden_terms:
        forbid_clause = (
            "다음 단어/표현은 감지 단서에 포함되지 않았으므로 사용하지 마십시오: "
            + ", ".join(forbidden_terms) + "."
        )

    # 카테고리별 스타일 힌트(있으면 제공)
    style_hints = STYLE_BOOK.get(job_ko, [])
    if style_hints:
        style_hints_text = "가능한 스타일 힌트: " + "; ".join(style_hints) + "."
    else:
        style_hints_text = "가능한 스타일 힌트: 카테고리 기본 복장과 활동성 중심으로 제안."

    alt_rule = ""
    if two_alternatives:
        alt_rule = "같은 답변에서 1안과 2안을 구분해 서로 다른 색/아이템 조합 두 가지를 제안하십시오."

    return (
        f"이미지 분석 결과 상위 직업 후보는 '{job_ko}'입니다.\n"
        f"감지 단서: {ev_text}.\n\n"
        "다음 지침에 따라 한국어 '문장형'으로 작성하십시오.\n"
        "첫 문장은 ‘당신에게 어울리는 스타일을 제안합니다.’로 시작하십시오.\n"
        "2~3문장에서 구체 아이템·색상을 제안하되, 감지 단서와 직업 특성에 부합하도록 변주하십시오.\n"
        "마지막 문장은 ‘이러한 … 때문에 … 직군의 단점을 보완합니다/도움이 됩니다.’ 형태의 근거를 제시하십시오.\n"
        "불릿/목록/코드블록/JSON을 사용하지 마십시오.\n"
        "각 문장을 마침표로 끝내고, 문장마다 줄바꿈을 하십시오(한 줄에 한 문장).\n"
        f"{style_hints_text}\n"
        f"{forbid_clause}\n"
        f"{alt_rule}\n"
        f"이제 '{job_ko}'에 대한 문장형 제안을 출력하십시오."
    )
